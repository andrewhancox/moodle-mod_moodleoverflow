{"version":3,"file":"functions.min.js","sources":["../src/functions.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Ajax functions for moodleoverflow\n *\n * @module     mod_moodleoverflow/functions\n * @copyright  2017 Tamara Gunkel\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/config', 'core/url', 'core/str'],\n    function($, ajax, templates, notification, Cfg, Url, str) {\n\n    var RATING_SOLVED = 3;\n    var RATING_REMOVE_SOLVED = 30;\n    var RATING_HELPFUL = 4;\n    var RATING_REMOVE_HELPFUL = 40;\n\n    var t = {\n\n        /**\n         * Reoords a upvote / downvote.\n         * @param {int} discussionid\n         * @param {int} ratingid\n         * @param {int} userid\n         * @param {event} event\n         * @returns {string}\n         */\n        recordvote: function(discussionid, ratingid, userid, event) {\n            var target = $(event.target).closest('.moodleoverflowpost');\n            var postid = target.attr('id');\n            postid = postid.substring(1);\n\n            var vote = ajax.call([{\n                methodname: 'mod_moodleoverflow_record_vote',\n                args: {\n                    discussionid: discussionid,\n                    postid: postid,\n                    ratingid: ratingid,\n                    sesskey: Cfg.sesskey\n                }\n            }\n            ]);\n\n            vote[0].done(function(response) {\n\n                var parentdiv = $(event.target).parent().parent();\n                // Update Votes.\n                if (ratingid === 2) {\n                    parentdiv.children('a:first-of-type').children().attr(\n                        'src', Url.imageUrl('vote/upvoted', 'moodleoverflow'));\n                    parentdiv.children('a:nth-of-type(2)').children().attr(\n                        'src', Url.imageUrl('vote/downvote', 'moodleoverflow'));\n                } else if (ratingid === 1) {\n                    parentdiv.children('a:first-of-type').children().attr(\n                        'src', Url.imageUrl('vote/upvote', 'moodleoverflow'));\n                    parentdiv.children('a:nth-of-type(2)').children().attr(\n                        'src', Url.imageUrl('vote/downvoted', 'moodleoverflow'));\n                } else {\n                    parentdiv.children('a:first-of-type').children().attr(\n                        'src', Url.imageUrl('vote/upvote', 'moodleoverflow'));\n                    parentdiv.children('a:nth-of-type(2)').children().attr(\n                        'src', Url.imageUrl('vote/downvote', 'moodleoverflow'));\n                }\n\n                parentdiv.children('p').text(response.postrating);\n\n                // Update user reputation.\n                templates.replaceNode($('.user-details,.author').find('a[href*=\"id=' + userid + '\"]')\n                    .siblings('span'), '<span>' + response.raterreputation + '</span>', \"\");\n                if (response.ownerid && userid !== response.ownerid) {\n                    templates.replaceNode($('.user-details,.author').find('a[href*=\"id=' + response.ownerid + '\"]')\n                        .siblings('span'), '<span>' + response.ownerreputation + '</span>', \"\");\n                }\n            }).fail(notification.exception);\n\n            return vote;\n        },\n\n        /**\n         * Initializes the clickevent on upvotes / downvotes.\n         * @param {int} discussionid\n         * @param {int} userid\n         */\n        clickevent: function(discussionid, userid) {\n            $(\".marksolved\").on(\"click\", function(event) {\n                var post = $(event.target).parents('.moodleoverflowpost');\n\n                if (post.hasClass('statusteacher') || post.hasClass('statusboth')) {\n                    // Remove solution mark.\n                    t.recordvote(discussionid, RATING_REMOVE_SOLVED, userid, event)[0].then(function() {\n                        t.removeSolvedFromPost(post);\n                    });\n                } else {\n                    // Add solution mark.\n                    t.recordvote(discussionid, RATING_SOLVED, userid, event)[0].then(function() {\n                        // Remove other solution mark in dom.\n                        t.removeOtherSolved(post.parent().parent());\n                        if (post.hasClass('statusstarter')) {\n                            post.removeClass('statusstarter');\n                            post.addClass('statusboth');\n                        } else {\n                            post.addClass('statusteacher');\n                        }\n\n                        var promiseStringNotSolved = str.get_string('marknotsolved', 'mod_moodleoverflow');\n                        $.when(promiseStringNotSolved).done(function(string) {\n                            $(event.target).text(string);\n                        });\n                        t.redoStatus(post);\n                    });\n                }\n\n\n            });\n\n            $(\".markhelpful\").on(\"click\", function(event) {\n                var post = $(event.target).parents('.moodleoverflowpost');\n\n                if (post.hasClass('statusstarter') || post.hasClass('statusboth')) {\n                    // Remove helpful mark.\n                    t.recordvote(discussionid, RATING_REMOVE_HELPFUL, userid, event)[0].then(function() {\n                        t.removeHelpfulFromPost(post);\n                    });\n                } else {\n                    // Add helpful mark.\n                    t.recordvote(discussionid, RATING_HELPFUL, userid, event)[0].then(function() {\n                        // Remove other helpful mark in dom.\n                        t.removeOtherHelpful(post.parent().parent());\n                        if (post.hasClass('statusteacher')) {\n                            post.removeClass('statusteacher');\n                            post.addClass('statusboth');\n                        } else {\n                            post.addClass('statusstarter');\n                        }\n\n                        var promiseStringNotHelpful = str.get_string('marknothelpful', 'mod_moodleoverflow');\n                        $.when(promiseStringNotHelpful).done(function(string) {\n                            $(event.target).text(string);\n                        });\n                        t.redoStatus(post);\n                    });\n                }\n\n            });\n        },\n\n        removeHelpfulFromPost: function (post) {\n            if (post.hasClass('statusstarter')) {\n                post.removeClass('statusstarter');\n            } else {\n                post.removeClass('statusboth');\n                post.addClass('statusteacher');\n            }\n\n            t.redoStatus(post);\n\n            var promiseHelpful = str.get_string('markhelpful', 'mod_moodleoverflow');\n            $.when(promiseHelpful).done(function (string) {\n                post.find('.markhelpful').text(string);\n            });\n        },\n\n        removeOtherHelpful: function(root) {\n            var formerhelpful = root.find('.statusstarter, .statusboth');\n            if (formerhelpful.length > 0) {\n                t.removeHelpfulFromPost(formerhelpful);\n            }\n        },\n\n        removeSolvedFromPost: function(post) {\n            if (post.hasClass('statusteacher')) {\n                post.removeClass('statusteacher');\n            } else {\n                post.removeClass('statusboth');\n                post.addClass('statusstarter');\n            }\n\n            t.redoStatus(post);\n\n            var promiseHelpful = str.get_string('marksolved', 'mod_moodleoverflow');\n            $.when(promiseHelpful).done(function(string) {\n                post.find('.marksolved').text(string);\n            });\n        },\n\n        removeOtherSolved: function(root) {\n            var formersolution = root.find('.statusteacher, .statusboth');\n            if (formersolution.length > 0) {\n                t.removeSolvedFromPost(formersolution);\n            }\n        },\n\n        /**\n         * Redoes the post status\n         * @param {object} post dom with .moodleoverflowpost which status should be redone\n         */\n        redoStatus: function(post) {\n            if ($(post).hasClass('statusboth')) {\n                var statusBothRequest = [\n                    {key: 'teacherrating', component: 'mod_moodleoverflow'},\n                    {key: 'starterrating', component: 'mod_moodleoverflow'},\n                    {key: 'bestanswer', component: 'mod_moodleoverflow'}\n                ];\n                str.get_strings(statusBothRequest).then(function(results) {\n                    var solved = templates.renderPix('i/status-solved', 'mod_moodleoverflow', results[0]);\n                    var helpful = templates.renderPix('i/status-helpful', 'mod_moodleoverflow', results[1]);\n                    $.when(solved, helpful).done(function(solvedImg, helpfulImg) {\n                        if (screen.width > 600) {\n                            post.find('.status').html(solvedImg + helpfulImg + results[2]);\n                        } else {\n                            post.find('.status').html(solvedImg + helpfulImg);\n                        }\n                    });\n                    return results;\n                });\n            } else if ($(post).hasClass('statusteacher')) {\n                var statusTeacherRequest = [\n                    {key: 'teacherrating', component: 'mod_moodleoverflow'},\n                    {key: 'solvedanswer', component: 'mod_moodleoverflow'}\n                ];\n                str.get_strings(statusTeacherRequest).then(function(results) {\n                    var circle = templates.renderPix('i/status-solved', 'mod_moodleoverflow', results[0]);\n                    $.when(circle).done(function(circleImg) {\n                        if (screen.width > 600) {\n                            post.find('.status').html(circleImg + results[1]);\n                        } else {\n                            post.find('.status').html(circleImg);\n                        }\n\n                    });\n                    return results;\n                });\n            } else if ($(post).hasClass('statusstarter')) {\n                var statusStarterRequest = [\n                    {key: 'starterrating', component: 'mod_moodleoverflow'},\n                    {key: 'helpfulanswer', component: 'mod_moodleoverflow'}\n                ];\n                str.get_strings(statusStarterRequest).then(function(results) {\n                    var box = templates.renderPix('i/status-helpful', 'mod_moodleoverflow', results[0]);\n                    $.when(box).done(function(boxImg) {\n                        if (screen.width > 600) {\n                            post.find('.status').html(boxImg + results[1]);\n                        } else {\n                            post.find('.status').html(boxImg);\n                        }\n                    });\n                    return results;\n                });\n            } else {\n                post.find('.status').html('');\n            }\n\n        }\n    };\n\n    return t;\n});\n"],"names":["define","$","ajax","templates","notification","Cfg","Url","str","t","recordvote","discussionid","ratingid","userid","event","postid","target","closest","attr","substring","vote","call","methodname","args","sesskey","done","response","parentdiv","parent","children","imageUrl","text","postrating","replaceNode","find","siblings","raterreputation","ownerid","ownerreputation","fail","exception","clickevent","on","post","parents","hasClass","then","removeSolvedFromPost","removeOtherSolved","removeClass","addClass","promiseStringNotSolved","get_string","when","string","redoStatus","removeHelpfulFromPost","removeOtherHelpful","promiseStringNotHelpful","promiseHelpful","root","formerhelpful","length","formersolution","get_strings","key","component","results","solved","renderPix","helpful","solvedImg","helpfulImg","screen","width","html","circle","circleImg","box","boxImg"],"mappings":"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"}